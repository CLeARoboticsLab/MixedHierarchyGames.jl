services:
  dev:
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Mount source code (changes reflected immediately)
      - .:/workspace
      # Mount git config for user identity (name, email)
      - ~/.gitconfig:/home/devuser/.gitconfig:ro
      # Mount SSH known_hosts for host verification
      - ~/.ssh/known_hosts:/home/devuser/.ssh/known_hosts:ro
      # Mount Claude config for auth
      - ~/.claude:/home/devuser/.claude
      # SSH agent forwarding (Docker Desktop for Mac only; Linux users need ${SSH_AUTH_SOCK} instead)
      - /run/host-services/ssh-auth.sock:/run/host-services/ssh-auth.sock
    environment:
      - SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock
      - PATH_LICENSE_STRING=1259252040&Courtesy&&&USR&GEN2035&5_1_2026&1000&PATH&GEN&31_12_2035&0_0_0&6000&0_0
      # Pass through ANTHROPIC_API_KEY if set on host
      - ANTHROPIC_API_KEY
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: /bin/bash

  test:
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    environment:
      - PATH_LICENSE_STRING=1259252040&Courtesy&&&USR&GEN2035&5_1_2026&1000&PATH&GEN&31_12_2035&0_0_0&6000&0_0
    working_dir: /workspace
    command: julia --project=. -e 'using Pkg; Pkg.test()'
